<launch>

    <!-- For sim -->
    <arg name="use_unity_binary" default="true"/>
    <arg name="use_gazebo_gui" default="false"/>
    <arg name="vehicle" default="iris_depth_camera"/>
    <arg name="unity_env" default="industrial_small_2"/>
    <arg name="use_global_cloud" default="true"/>
    <arg name="global_cloud_node_name" default="global_map_server"/>

    <!-- MAVROS configs -->
    <arg name="fcu_url" default="udp://:14540@localhost:14557"/>

    <!-- Planner configs -->
    <arg name="use_kino_planner" default="true" />
    <arg name="map_size_x" default="100.0"/>
    <arg name="map_size_y" default="100.0"/>
    <arg name="map_size_z" default="8.0"/>

    <arg name="odom_topic" default="/mavros/local_position/odom" />
    <arg name="camera_pose_topic" default="/camera/pose"/>
    <arg name="depth_topic" default="/fed_ros/depth"/>
    <arg name="global_cloud_topic" default="/$(arg global_cloud_node_name)/global_map"/>
    <arg name="local_cloud_topic" default="/pcl_render_node/cloud"/>

    <arg name="max_vel" default="3.0" />
    <arg name="max_acc" default="7.0" />

    <!-- Initial drone's position in Gazebo -->
    <arg name="init_pos_x" default="0.0" />
    <arg name="init_pos_y" default="0.0" />
    <!-- takeoff height -->
    <arg name="takeoff_height" default="2.0" />
    <!-- flight height -->
    <arg name="flight_height" default="3.0"/>

    <!-- ROS static transformation -->
    <node pkg="tf" type="static_transform_publisher" name="world_map_linker" args="0 0 0 0 0 0 world map 100" />
    <node pkg="tf" type="static_transform_publisher" name="tf_camera" args="0.1 0 0.0 -1.57 0 -1.57 base_link camera_link 33"/>

    <!-- MAVROS + PX4 + Gazebo -->
    <include file="$(find px4_fast_planner)/launch/mavros_unity.launch" >
        <arg name="use_unity_binary" value="$(arg use_unity_binary)"/>
        <arg name="unity_env" value="$(arg unity_env)"/>
        <arg name="use_gazebo_gui" value="$(arg use_gazebo_gui)"/>
        <arg name="vehicle" value="$(arg vehicle)"/>
        <arg name="fcu_url" value="$(arg fcu_url)"/>
        <arg name="x" value="$(arg init_pos_x)"/>
        <arg name="y" value="$(arg init_pos_y)"/>

        <arg name="use_global_cloud" default="$(arg use_global_cloud)"/>
        <arg name="global_cloud_node_name" default="$(arg global_cloud_node_name)"/>
    </include>

    <!-- Fast planner -->
    <include unless="$(arg use_kino_planner)" file="$(find px4_fast_planner)/launch/px4_topo_replan.launch" >
        <arg name="map_size_x" value="$(arg map_size_x)"/>
        <arg name="map_size_y" value="$(arg map_size_y)"/>
        <arg name="map_size_z" value="$(arg map_size_z)"/>

        <arg name="max_vel" value="$(arg max_vel)"/>
        <arg name="max_acc" value="$(arg max_acc)"/>

        <arg name="odom_topic" value="$(arg odom_topic)" />
        <arg name="depth_topic" value="$(arg depth_topic)"/>
        <arg name="camera_pose_topic" value="$(arg camera_pose_topic)"/>

        <arg name="use_global_cloud" default="$(arg use_global_cloud)"/>
        <arg name="global_cloud_topic" default="$(arg global_cloud_topic)"/>
        <arg name="local_cloud_topic" default="$(arg local_cloud_topic)"/>

        <arg name="flight_height" value="$(arg flight_height)"/>
    </include>

    <include if="$(arg use_kino_planner)" file="$(find px4_fast_planner)/launch/px4_kino_replan.launch" >
        <arg name="map_size_x" value="$(arg map_size_x)"/>
        <arg name="map_size_y" value="$(arg map_size_y)"/>
        <arg name="map_size_z" value="$(arg map_size_z)"/>

        <arg name="max_vel" value="$(arg max_vel)"/>
        <arg name="max_acc" value="$(arg max_acc)"/>

        <arg name="odom_topic" value="$(arg odom_topic)" />
        <arg name="depth_topic" value="$(arg depth_topic)"/>
        <arg name="camera_pose_topic" value="$(arg camera_pose_topic)"/>

        <arg name="use_global_cloud" default="$(arg use_global_cloud)"/>
        <arg name="global_cloud_topic" default="$(arg global_cloud_topic)"/>
        <arg name="local_cloud_topic" default="$(arg local_cloud_topic)"/>

        <arg name="flight_height" value="$(arg flight_height)"/>
    </include>

    <!-- Geometric controller -->
    <include file="$(find px4_fast_planner)/launch/geometric_controller.launch">
        <arg name="gazebo_simulation" value="true" />
        <arg name="max_acc" value="$(arg max_acc)" />
        <arg name="Kp_x" value="6.0" />
        <arg name="Kp_y" value="6.0" />
        <arg name="Kp_z" value="6.0" />
        <arg name="Kv_x" value="1.5" />
        <arg name="Kv_y" value="1.5" />
        <arg name="Kv_z" value="3.5" />
        <arg name="init_pos_x" value="0.0" />
        <arg name="init_pos_y" value="0.0" />
        <arg name="init_pos_z" value="$(arg takeoff_height)" />
    </include>

    <!-- Camera pose publisher -->
    <!-- This node publishes tf from parent_frame to child_frame-->
    <node pkg="px4_fast_planner" name="camera_pose_publisher" type="camera_pose_publisher.py" output="screen">
        <param name="parent_frame" value="world" />
        <param name="child_frame" value="camera_link" />
        <param name="pose_topic" value="camera/pose" />
    </node>

    <!-- Fisheye Depth -->
    <include file="$(find fed_ros)/launch/ds_sp_sgm_s_0.5_simu.launch">
        <arg name="offset_x" value="0" />
        <arg name="offset_y" value="0" />
        <arg name="crop_w" value="720" />
        <arg name="crop_h" value="540" />
        <arg name="scale" value="1.0" />
        <arg name="leftImage_topic" value="/fisheye_image_left"/>
        <arg name="rightImage_topic" value="/fisheye_image_right"/>
    </include>

    <node pkg="px4_fast_planner" name="traj_msg_converter" type="trajectory_msg_converter.py" output="screen">
        <param name="fast_planner_traj_topic" value="planning/ref_traj"/>
        <param name="traj_pub_topic" value="command/trajectory"/>
    </node>

    <!-- Rviz -->
    <include file="$(find px4_fast_planner)/launch/rviz.launch" />

    <!-- Goal type: 0 for manual setting in rviz, 1 for automatic generation in Unity -->
    <param name="goal_set_type" type="int" value="0"/>
    <param name="goal_radius" type="double" value="0"/>
    <param name="goal_range" type="double" value="0"/>

</launch>